# vim: set syntax=helm:

{{- $fullname := include "ckan.fullname" . -}}

{{- $sessionEncryptKeySecret := lookup "v1" "Secret" .Release.Namespace .Values.config.session.encryptKey.secretName }}
{{- $sessionEncryptKey := "" }}
{{- if $sessionEncryptKeySecret }}
  {{- $sessionEncryptKey = (get $sessionEncryptKeySecret "data").key | b64dec }}
{{- end }}{{/* sessionEncryptKeySecret */}}

{{- $sessionValidateKeySecret := lookup "v1" "Secret" .Release.Namespace .Values.config.session.validateKey.secretName }}
{{- $sessionValidateKey := "" }}
{{- if $sessionValidateKeySecret }}
  {{- $sessionValidateKey = (get $sessionValidateKeySecret "data").key | b64dec }}
{{- end }}{{/* sessionValidateKeySecret */}}

{{- $csrfSecretKeySecret := lookup "v1" "Secret" .Release.Namespace .Values.config.csrfProtection.secret.secretName }}
{{- $csrfSecretKey := "" }}
{{- if $csrfSecretKeySecret }}
  {{- $csrfSecretKey = (get $csrfSecretKeySecret "data").key | b64dec }}
{{- end }}{{/* $csrfSecretKeySecret */}}

{{- $databasePasswordSecret := lookup "v1" "Secret" .Release.Namespace .Values.config.database.password.secretName }}
{{- $databasePassword := "" }}
{{- if $databasePasswordSecret }}
  {{- $databasePassword = (get $databasePasswordSecret "data").password | b64dec }}
{{- end }}{{/* databasePasswordSecret */}}
{{- $databaseUser := .Values.config.database.username }}
{{- $databaseHost := .Values.config.database.host }}
{{- $databasePort := .Values.config.database.port | int }}
{{- $databaseName := .Values.config.database.dbname }}

---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-config-generated
  labels:
    {{- include "ckan.labels" . | nindent 4 }}
stringData:
  10-session.ini: |-
    beaker.session.secret={{ $sessionEncryptKey }}
    beaker.session.validate_key={{ $sessionValidateKey }}
  20-csrf.ini: |-
    WTF_CSRF_SECRET_KEY={{ $csrfSecretKey }}

# see https://docs.ckan.org/en/2.10/maintaining/configuration.html#environment-variables
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $fullname }}-env-generated
  labels:
    {{- include "ckan.labels" . | nindent 4 }}
stringData:
  CKAN_SQLALCHEMY_URL: {{ printf "postgresql://%s:%s@%s:%d/%s" $databaseUser $databasePassword $databaseHost $databasePort $databaseName }}
  CKAN_SITE_URL: {{ .Values.config.url }}
  CKAN_REDIS_URL: {{ .Values.config.redis.url }}
  CKAN_SOLR_URL: {{ .Values.config.solr.url }}

